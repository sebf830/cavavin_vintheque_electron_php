<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Journal de d√©gustation | Cavavin</title>
  <link rel="stylesheet" href="../public/assets/global_style.css" />

  <script defer type="module">
    import Alpine from '../public/vendor/alpine/module.esm.js';
    window.Alpine = Alpine;
    Alpine.start();
  </script>

  <!-- Local Tailwind : self generated -->
  <link rel="stylesheet" href="../libs/tailwind.css" />

</head>
<body x-data="{ sidebarOpen: false }" class="bg-creme flex h-screen bg-gray-50 font-sans">

  <!-- Overlay mobile -->
  <div 
    class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden"
    x-show="sidebarOpen"
    x-transition.opacity
    @click="sidebarOpen = false"
  ></div>

  <!-- Sidebar -->
  <aside 
    class="fixed md:static z-40 inset-y-0 left-0 w-64 bg-gray-900 text-white transform md:translate-x-0 transition-transform duration-200 ease-in-out"
    :class="{ '-translate-x-full': !sidebarOpen }"
  >
    <div class="p-6 text-2xl font-bold">üç∑ Cavavin</div>
    <nav class="space-y-2 px-4">
      <a href="#" onclick="window.location.href='dashboard.html'" class="block px-4 py-2 rounded hover:bg-gray-700">üìä Tableau de bord</a>
      <a href="#" onclick="window.location.href='addBottle.html'" class="block px-4 py-2 rounded hover:bg-gray-700">‚ûï Ajouter</a>
      <a href="#" onclick="window.location.href='inventaire.html'" class="block px-4 py-2 rounded hover:bg-gray-700">üì¶ Inventaire</a>
      <a href="#" onclick="window.location.href='journal.html'" class="block px-4 py-2 rounded hover:bg-gray-700">üìï Journal</a>
      <a href="#" onclick="window.location.href='parametres.html'" class="block px-4 py-2 rounded hover:bg-gray-700">‚öôÔ∏è Param√®tres</a>
    </nav>
  </aside>

  <!-- Contenu principal -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Topbar -->
    <header class="bg-white shadow-md p-4 flex items-center justify-between md:hidden">
      <button @click="sidebarOpen = !sidebarOpen" class="text-gray-700 text-2xl">
        ‚ò∞
      </button>
      <h1 class="text-xl font-bold text-liedevin">Cavavin</h1>
    </header>

    <!-- Contenu -->
    <main class="flex-1 overflow-y-auto p-6 bg-creme" x-data="journalApp()" x-init="init()" >
        <h1 class="text-3xl font-bold text-liedevin mb-8 text-center">Journal de d√©gustation</h1>

        <template x-if="notification">
          <div class="mb-4 p-3 bg-green-200 text-green-700 border border-green-700 rounded text-center shadow max-w-xl mx-auto">
            <span x-text="notification"></span>
          </div>
        </template>

     
  <!-- Navigation HAUT -->
  <div class="max-w-3xl mx-auto flex justify-between items-center mb-6 px-4">
    <button 
      @click="prevPage()" 
      :disabled="page === 1" 
      class="px-5 py-2 rounded disabled:opacity-40 bg-liedevin-gradient hover:bg-[#a06a57] text-white transition"
    >
      ‚Üê Pr√©c√©dent
    </button>
    <div class="text-[#5d4037] font-semibold">
      Page <span x-text="page"></span> / <span x-text="totalPages()"></span>
    </div>
    <button 
      @click="nextPage()" 
      :disabled="page === totalPages()" 
      class="px-5 py-2 rounded disabled:opacity-40 bg-liedevin-gradient hover:bg-[#a06a57] text-white transition"
    >
      Suivant ‚Üí
    </button>
  </div>


  <!-- Notes -->
  <template x-if="loading">
    <p class="italic text-gray-600 text-center max-w-3xl mx-auto">Chargement des notes...</p>
  </template>

  <template x-if="!loading && notes.length === 0">
    <p class="italic text-gray-600 text-center max-w-3xl mx-auto">Aucune note disponible.</p>
  </template>

  <template x-if="!loading && notes.length > 0" >
    <div class="max-w-3xl mx-auto grid grid-cols-2 gap-6" >
      <template x-for="note in pagedNotes()" :key="note.id">
        <article class="relative bg-[#fffbee] border border-[#d7ccc8] rounded-2xl shadow-md p-6 leading-relaxed">
          <!-- Imitation tranche -->
          <div class="absolute left-2 top-4 bottom-4 w-1.5 bg-[#b27a6a] rounded-sm"></div>

          <h3 class="text-[#5d4037] text-2xl mb-1" x-text="note.titre ? note.titre : 'sans_titre' "></h3>
          <div class="date text-[#8d6e63] italic text-sm mb-4" x-text="note.creation_date.date ? formatDate(note.creation_date.date): 'non dat√©e' "></div>
          <div class="date text-[#8d6e63] italic text-sm mb-4" x-text="note.bottle ? note.bottle.name + ' (' + note.bottle.domaine + ')' + ' ' + note.bottle.year : ''"></div>

          <div class="flex items-center gap-1 mb-4">
            <template x-for="i in 5">
              <svg 
                :class="{'text-yellow-400': i <= note.rating, 'text-gray-300': i > note.rating}" 
                class="w-5 h-5 fill-current" 
                viewBox="0 0 20 20" 
                xmlns="http://www.w3.org/2000/svg"
              >
                <path d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.561-.954L10 0l2.951 5.956 6.561.954-4.756 4.635 1.122 6.545z"/>
              </svg>
            </template>
        </div>

         <div class="flex justify-start gap-2 ">
            <a 
              :href="`journalPage.html?id=${note.id}`"
              class="bg-liedevin-gradient hover:bg-gradient-to-b from-[#2f2f2f] to-[#101010] text-white px-8 py-1 rounded text-lg font-semibold transition"
            >
              lire
          </a>
          <button
              @click="deleteNote(note.id)"
              class="bg-liedevin-gradient hover:bg-gradient-to-b from-[#2f2f2f] to-[#101010] text-white px-8 py-1 rounded text-lg font-semibold transition"
            >
              supprimer
          </button>
       </div>  

        </article>
      </template>
    </div>
  </template>


  <div class="flex justify-center gap-2 max-w-3xl mx-auto text-center mt-12">
    <a 
        onclick="window.location.href='dashboard.html'"
        href="#" 
      class="bg-liedevin-gradient text-white px-8 py-3 rounded hover:bg-gradient-to-b from-[#2f2f2f] to-[#101010] transition"
    >
      Retour dashboard
  </a>
    <button 
      href="#" onclick="window.location.href='addNote.html'"
      class="inline-block bg-liedevin-gradient hover:bg-gradient-to-b from-[#2f2f2f] to-[#101010] text-white px-8 py-3 rounded text-lg font-semibold transition"
    >
      + Ajouter une nouvelle note
    </button>
  </div>
</main>
</div>



<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('journalApp', () => ({
      initialized: false,
      notes: [],
      page: 1,
      perPage: 4,
      loading: true,
      backendUrl: '',
      notification: null,

      async init() {
        if (this.initialized) return;
        this.initialized = true;

        this.backendUrl = await window.electronAPI.getBackendUrl();
        this.fetchNotes();
      },

      async fetchNotes() {
        try {
          const res = await fetch(`${this.backendUrl}/api/notes`);
          if(!res.ok) throw new Error('Erreur lors du chargement des notes');
          this.notes = await res.json();
        } catch(e) {
          console.error(e);
          this.notes = [];
        } finally {
          this.loading = false;
        }
      },

      pagedNotes() {
        const start = (this.page - 1) * this.perPage;
        return this.notes.slice(start, start + this.perPage);
      },

      totalPages() {
        return Math.max(1, Math.ceil(this.notes.length / this.perPage));
      },

      nextPage() {
        if(this.page < this.totalPages()) this.page++;
      },

      prevPage() {
        if(this.page > 1) this.page--;
      },

      formatDate(dateStr) {
        if(!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
      },

      async deleteNote(noteId) {
        if (!confirm("Voulez-vous vraiment supprimer cette note ?")) return;

        try {
          const res = await fetch(`${this.backendUrl}/api/delete-note/${noteId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (!res.ok) throw new Error("√âchec de la suppression");

          this.notification = "Note supprim√©e ‚úÖ";

          // Refresh les notes sans recharger la page
          await this.fetchNotes();
          if (this.page > this.totalPages()) this.page = this.totalPages(); // √©viter page vide

        } catch (e) {
          console.error(e);
          this.notification = "Erreur lors de la suppression ‚ùå";
        }

        // Nettoie la notification apr√®s 2 sec
        setTimeout(() => {
          this.notification = null;
        }, 2000);
      }

   }));
});
</script>

    </body>
</html>